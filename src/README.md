Much of this code is being rearranged (hopefully into a library) someday.
